Common
 └── DataAccess
     └── Repositories
         ├── IIcmpRuleRepository.cs
         └── IcmpRuleRepository.cs
using System.Collections.Generic;
using Common.Rules;

namespace Common.DataAccess.Repositories
{
    public interface IIcmpRuleRepository
    {
        IReadOnlyList<PropertyRule> GetDocumentRules(string departmentCode);

        IReadOnlyList<RelationshipRule> GetRelationshipRules(string departmentCode);
    }
}

using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using Common.EntityFramework;
using Common.EntityFramework.Entities;
using Common.Rules;

namespace Common.DataAccess.Repositories
{
    public class IcmpRuleRepository : IIcmpRuleRepository
    {
        private readonly AppDbContext _db;

        public IcmpRuleRepository(AppDbContext db)
        {
            _db = db;
        }

        public IReadOnlyList<PropertyRule> GetDocumentRules(string departmentCode)
        {
            var entities = _db.IcmpRules
                .Where(r =>
                    r.DepartmentCode == departmentCode &&
                    r.IsActive &&
                    r.TargetType == "DOCUMENT")
                .OrderBy(r => r.SortOrder)
                .ToList();

            return entities.Select(MapToPropertyRule).ToList();
        }

        public IReadOnlyList<RelationshipRule> GetRelationshipRules(string departmentCode)
        {
            var entities = _db.IcmpRules
                .Where(r =>
                    r.DepartmentCode == departmentCode &&
                    r.IsActive &&
                    r.TargetType == "RELATIONSHIP")
                .OrderBy(r => r.SortOrder)
                .ToList();

            return entities.Select(MapToRelationshipRule).ToList();
        }

        // -------------------------------
        // Mapping helpers
        // -------------------------------

        private static PropertyRule MapToPropertyRule(IcmpRuleEntity entity)
        {
            return new PropertyRule
            {
                RuleName = $"DOC_{entity.PropertyKey}",
                PropertyKey = entity.PropertyKey,
                Action = PropertyAction.Add,
                ValueExpression = BuildValueExpression(entity),
                Conditions = DeserializeConditions(entity.ConditionsJson),
                Order = entity.SortOrder
            };
        }

        private static RelationshipRule MapToRelationshipRule(IcmpRuleEntity entity)
        {
            return new RelationshipRule
            {
                RuleName = $"{entity.TargetObjectType}_{entity.PropertyKey}",
                ObjectType = entity.TargetObjectType!,
                PropertyKey = entity.PropertyKey,
                Action = PropertyAction.Add,
                ValueExpression = BuildValueExpression(entity),
                Conditions = DeserializeConditions(entity.ConditionsJson),
                Order = entity.SortOrder
            };
        }

        private static string BuildValueExpression(IcmpRuleEntity entity)
        {
            return entity.SourceType.ToUpper() switch
            {
                "STATIC" => $"Static:{entity.SourceValue}",
                _ => entity.SourceValue
            };
        }

        private static List<RuleCondition> DeserializeConditions(string? json)
        {
            if (string.IsNullOrWhiteSpace(json))
                return new List<RuleCondition>();

            return JsonSerializer.Deserialize<List<RuleCondition>>(json)
                   ?? new List<RuleCondition>();
        }
    }
}


services.AddScoped<IIcmpRuleRepository, IcmpRuleRepository>();


var documentRules =
    _ruleRepository.GetDocumentRules(model.DepartmentCode);

var relationshipRules =
    _ruleRepository.GetRelationshipRules(model.DepartmentCode);

var docRules = repo.GetDocumentRules("CRH");
var relRules = repo.GetRelationshipRules("CRHI");
