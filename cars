Common
 └── Rules
     ├── RelationshipRule.cs
     ├── RelationshipRuleEngine.cs

using System.Collections.Generic;

namespace Common.Rules
{
    /// <summary>
    /// Rule that produces a property for a relationship object
    /// (EMP_ENTY, DEAL, etc.)
    /// </summary>
    public class RelationshipRule
    {
        public string RuleName { get; set; } = string.Empty;

        /// <summary>
        /// Relationship object type (EMP_ENTY, DEAL, etc.)
        /// </summary>
        public string ObjectType { get; set; } = string.Empty;

        public List<RuleCondition> Conditions { get; set; } = new();

        public PropertyAction Action { get; set; }

        public string PropertyKey { get; set; } = string.Empty;

        /// <summary>
        /// FIELD name or Static:value
        /// </summary>
        public string? ValueExpression { get; set; }

        public int Order { get; set; }
    }
}


using System;
using System.Collections.Generic;
using System.Linq;
using Common.Context;
using Common.Models;

namespace Common.Rules
{
    public class RelationshipRuleEngine
    {
        public Dictionary<string, List<Property>> Execute(
            IEnumerable<RelationshipRule> rules,
            ImageRuleContext context)
        {
            // Key = ObjectType (EMP_ENTY, DEAL)
            var result = new Dictionary<string, Dictionary<string, Property>>(
                StringComparer.OrdinalIgnoreCase);

            foreach (var rule in rules.OrderBy(r => r.Order))
            {
                if (!ConditionEvaluator.EvaluateAll(rule.Conditions, context))
                    continue;

                if (!result.ContainsKey(rule.ObjectType))
                    result[rule.ObjectType] =
                        new Dictionary<string, Property>(StringComparer.OrdinalIgnoreCase);

                var props = result[rule.ObjectType];

                switch (rule.Action)
                {
                    case PropertyAction.Add:
                    case PropertyAction.Update:
                        var value = ResolveValue(rule.ValueExpression, context);
                        if (value == null) continue;

                        props[rule.PropertyKey] = new Property
                        {
                            key = rule.PropertyKey,
                            value = value
                        };
                        break;

                    case PropertyAction.Remove:
                        props.Remove(rule.PropertyKey);
                        break;
                }
            }

            // Convert to expected output
            return result.ToDictionary(
                k => k.Key,
                v => v.Value.Values.ToList(),
                StringComparer.OrdinalIgnoreCase);
        }

        private static string? ResolveValue(
            string? expression,
            ImageRuleContext context)
        {
            if (string.IsNullOrWhiteSpace(expression))
                return null;

            if (expression.StartsWith("Static:", StringComparison.OrdinalIgnoreCase))
                return expression.Substring(7);

            return context.GetValue(expression)?.ToString();
        }
    }
}



using System.Collections.Generic;
using System.Linq;
using Common.Models;

namespace Common.Builders
{
    public static class RelationshipBuilder
    {
        public static List<Relationship> Build(
            Dictionary<string, List<Property>> relationshipProperties)
        {
            return relationshipProperties.Select(r => new Relationship
            {
                objectType = r.Key,
                properties = r.Value.ToArray()
            }).ToList();
        }
    }
}


var context = ImageRuleContextFactory.Create(model);

var documentProps =
    propertyRuleEngine.Execute(documentRules, context);

var relationshipProps =
    relationshipRuleEngine.Execute(relationshipRules, context);

var imageFile = new ImageFile
{
    Properties = documentProps.ToArray(),
    Relationships = RelationshipBuilder.Build(relationshipProps)
};
