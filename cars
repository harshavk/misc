public class ImageIngestionService
{
    private readonly IIcmpRuleRepository _ruleRepository;
    private readonly PropertyRuleEngine _propertyRuleEngine;
    private readonly RelationshipRuleEngine _relationshipRuleEngine;

    public ImageIngestionService(
        IIcmpRuleRepository ruleRepository,
        PropertyRuleEngine propertyRuleEngine,
        RelationshipRuleEngine relationshipRuleEngine)
    {
        _ruleRepository = ruleRepository;
        _propertyRuleEngine = propertyRuleEngine;
        _relationshipRuleEngine = relationshipRuleEngine;
    }

    public ImageFile BuildImageFile(ImageManagementModel model)
    {
        // STEP 1: Build context
        var context = ImageRuleContextFactory.Create(model);

        // STEP 2: Load rules (DB / cache)
        var documentRules =
            _ruleRepository.GetDocumentRules(model.DepartmentCode);

        var relationshipRules =
            _ruleRepository.GetRelationshipRules(model.DepartmentCode);

        // STEP 3: Execute engines
        var documentProperties =
            _propertyRuleEngine.Execute(documentRules, context);

        var relationshipProperties =
            _relationshipRuleEngine.Execute(relationshipRules, context);

        // STEP 4: Final assembly
        return new ImageFile
        {
            EmployeeId = model.EmployeeId,
            Barcode = model.Barcode,
            DepartmentCode = model.DepartmentCode,
            Properties = documentProperties.ToArray(),
            Relationships =
                RelationshipBuilder.Build(relationshipProperties).ToArray()
        };
    }
}
