// 1. Auto-save Messages (Keep as is)
    effect(() => {
      const msgs = this.chatMessages();
      const tid = this.currentThreadId();
      if (msgs.length > 0) {
        this.ai.saveHistory(tid, msgs).subscribe();
      }
    });

    // 2. Auto-save Sidebar (Keep as is)
    effect(() => {
      const history = this.chatHistory();
      const userId = this.currentUser()?.id;
      if (userId && history.length > 0) {
        localStorage.setItem(`wf_sidebar_${userId}`, JSON.stringify(history));
      }
    });

    // âœ… FIX 3: WATCH USER CHANGES ONLY
    effect(() => {
      // 1. We read the signal we WANT to track
      const user = this.currentUser();

      // 2. We wrap everything else in untracked() 
      // This prevents the effect from running when chatHistory changes
      untracked(() => {
        if (user) {
          // Reset view
          this.chatMessages.set([]);
          this.lastResponse.set(null);
          
          // Restore state for the new user
          this.restoreSidebarHistoryForUser(user.id);
          this.restoreLastActiveThreadForUser(user.id);
        }
      });
    }, { allowSignalWrites: true });
