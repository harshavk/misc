from fastapi import Depends, HTTPException
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from src.utils.jwt_utils import decode_token

security = HTTPBearer()

def get_current_user(
    creds: HTTPAuthorizationCredentials = Depends(security)
):
    token = creds.credentials
    payload = decode_token(token)

    if not payload or "sub" not in payload:
        raise HTTPException(status_code=401, detail="Invalid token")

    return {
        "employee_id": payload["sub"],
        "role": payload.get("role")
    }


import csv
from pathlib import Path

ORG_FILE = Path("data/org_chart.csv")

class OrgRepository:

    def get_direct_reports(self, manager_id: str) -> list[dict]:
        results = []

        with open(ORG_FILE, newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                if row.get("manager_id") == manager_id:
                    results.append(row)

        return results


from src.repositories.org_repository import OrgRepository

_repo = OrgRepository()

def get_dashboard_team(employee_id: str):
    reports = _repo.get_direct_reports(employee_id)

    return [
        {
            "employeeId": r["employee_id"],
            "name": r["name"],
            "role": r["role"],
            "email": r["email"],
            "image": r["image"]
        }
        for r in reports
    ]


from fastapi import APIRouter, Depends
from src.utils.jwt_dependency import get_current_user
from src.services.dashboard_service import get_dashboard_team

router = APIRouter(prefix="/api/dashboard", tags=["Dashboard"])

@router.get("/team")
def get_my_team(current_user=Depends(get_current_user)):
    employee_id = current_user["employee_id"]
    return {
        "managerId": employee_id,
        "team": get_dashboard_team(employee_id)
    }


from src.api.dashboard import router as dashboard_router

app.include_router(dashboard_router)


