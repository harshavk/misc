// src/app/features/mybuddy/mybuddy.ts

// 1. Import the Child Component
import { ChatAreaComponent } from './components/chat-area/chat-area'; 

export class MyBuddy implements OnInit, OnDestroy {

  // 2. Get reference to the child component
  @ViewChild(ChatAreaComponent) private chatArea!: ChatAreaComponent;

  ngOnInit(): void {
    const state = history.state as { autoPrompt?: string };
    
    // Flag to track if we handled a redirect (so we don't double-submit via URL params)
    let handledViaState = false;

    this.restoreSidebarHistory();

    // --- LOGIC A: Handle Redirect (State) ---
    this.loadActiveThread(() => {
      if (state && state.autoPrompt) {
        console.log('ðŸ“ Pre-filling input from State:', state.autoPrompt);
        
        // 1. Set the text (Do NOT submit)
        this.queryControl.setValue(state.autoPrompt!);
        handledViaState = true; 

        // 2. Focus the input using the Child Component reference
        setTimeout(() => {
          if (this.chatArea) {
            this.chatArea.focusInput();
          }
        }, 100);
      }
    });

    setTimeout(() => this.isInitializing.set(false), 1500);
    this.startHelperRotation();
    
    // --- LOGIC B: Handle Deep Links (Query Params) ---
    this.route.queryParams.subscribe(params => {
       const incomingQuery = params['q'];
       
       // Only run this if we DIDN'T just handle a state redirect
       if (incomingQuery && !handledViaState) {
         console.log('ðŸ”— Pre-filling input from URL');
         this.queryControl.setValue(incomingQuery);
         this.submitQuery();
         this.router.navigate([], { queryParams: { q: null }, queryParamsHandling: 'merge', replaceUrl: true });
       }
    });
  }
}

---------------
// src/app/features/mybuddy/components/chat-area/chat-area.ts

export class ChatAreaComponent {
  // ... existing code ...
  @ViewChild('chatInput') private chatInput!: ElementRef<HTMLTextAreaElement>;

  // âœ… Add this Public Method
  focusInput(): void {
    this.chatInput?.nativeElement?.focus();
  }
}
