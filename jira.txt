using Microsoft.Extensions.Configuration;
using Microsoft.Data.SqlClient;

// Load appsettings.json
var config = new ConfigurationBuilder()
    .AddJsonFile("appsettings.json", optional: false)
    .Build();

var connStr = config.GetConnectionString("DefaultConnection")!;

// Read keys from YOUR application's config file
var targetConfig = new ConfigurationBuilder()
    .AddJsonFile("appsettings.json", optional: false)
    .AddJsonFile("appsettings.Development.json", optional: true)
    .Build();

// Flatten key-values
var allKeys = targetConfig.AsEnumerable()
    .Where(kv => !string.IsNullOrWhiteSpace(kv.Key) && kv.Value is not null)
    .ToList();

Console.WriteLine($"Found {allKeys.Count} keys to insert…");

// Insert all into DB (NO check, NO update)
using var conn = new SqlConnection(connStr);
await conn.OpenAsync();

foreach (var kv in allKeys)
{
    var cmd = conn.CreateCommand();
    cmd.CommandText = @"INSERT INTO AppConfigs (AppConfigName, AppConfigValue, ModifiedBy) 
                        VALUES (@name, @value, @modifiedBy)";
    cmd.Parameters.AddWithValue("@name", kv.Key);
    cmd.Parameters.AddWithValue("@value", kv.Value ?? "");
    cmd.Parameters.AddWithValue("@modifiedBy", "Migration");

    await cmd.ExecuteNonQueryAsync();
}

Console.WriteLine("✅ Insert completed successfully!");
