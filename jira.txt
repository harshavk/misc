// src/app/core/services/ai-search.service.ts

export class AiSearchService {
  // ... existing code ...

  // âœ… Add this property
  private _pendingRedirectPrompt: string | null = null;

  setRedirectPrompt(prompt: string) {
    this._pendingRedirectPrompt = prompt;
  }

  getAndClearRedirectPrompt(): string | null {
    const temp = this._pendingRedirectPrompt;
    this._pendingRedirectPrompt = null; // Clear it so it doesn't run again on refresh
    return temp;
  }
}

// src/app/features/employee-detail/employee-detail.component.ts

openAccessDialog() {
  const dialogRef = this.dialog.open(BuddyAccessDialog, { /*...*/ });

  dialogRef.afterClosed().subscribe(result => {
    if (result) {
      // âœ… 1. Store the prompt in the service
      this.aiService.setRedirectPrompt(result);
      
      // âœ… 2. Navigate cleanly (No query params, no state)
      this.router.navigate(['/ally']); 
    }
  });
}

// src/app/features/mybuddy/mybuddy.ts
import { ChatAreaComponent } from './components/chat-area/chat-area'; 

export class MyBuddy implements OnInit, OnDestroy {
  @ViewChild(ChatAreaComponent) private chatArea!: ChatAreaComponent;

  ngOnInit(): void {
    // 1. Check Service for pending prompt (Synchronously)
    const pendingPrompt = this.ai.getAndClearRedirectPrompt();
    const hasRedirect = !!pendingPrompt;

    this.restoreSidebarHistory();

    // 2. Load History
    this.loadActiveThread(() => {
      // If we have a prompt from the service, use it
      if (pendingPrompt) {
        console.log('ðŸ“ Pre-filling input from Service:', pendingPrompt);
        
        // A. Set Text (No Submit)
        this.queryControl.setValue(pendingPrompt);

        // B. Focus Input
        setTimeout(() => {
          if (this.chatArea) this.chatArea.focusInput();
        }, 100);
      }
    });

    setTimeout(() => this.isInitializing.set(false), 1500);
    this.startHelperRotation();
    
    // 3. Query Params Logic (Blocked if we found a Redirect Prompt)
    this.route.queryParams.subscribe(params => {
       // If we already handled a service redirect, IGNORE the URL
       if (hasRedirect) return;

       const incomingQuery = params['q'];
       if (incomingQuery) {
         console.log('ðŸ”— Auto-submitting from URL');
         this.queryControl.setValue(incomingQuery);
         this.submitQuery();
         this.router.navigate([], { queryParams: { q: null }, queryParamsHandling: 'merge', replaceUrl: true });
       }
    });
  }
}
