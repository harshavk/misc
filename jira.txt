// src/app/features/mybuddy/mybuddy.ts

ngOnInit(): void {
  // 1. Capture State
  const state = history.state as { autoPrompt?: string };

  this.restoreSidebarHistory();

  // 2. Load History
  this.loadActiveThread(() => {
    
    // 3. After history loads, check for redirect
    if (state && state.autoPrompt) {
      console.log('ðŸ“ Pre-filling input with:', state.autoPrompt);

      // âœ… FIX: "!" tells TypeScript it's not undefined
      // We just set the text. We do NOT auto-submit.
      this.queryControl.setValue(state.autoPrompt!);
      
      // Optional: Focus the input so they can just hit Enter
      setTimeout(() => {
        this.chatInput.nativeElement.focus();
      }, 100);
    }
  });

  setTimeout(() => this.isInitializing.set(false), 1500);
  this.startHelperRotation();
  
  // URL Query Params Logic...
  this.route.queryParams.subscribe(params => {
     const incomingQuery = params['q'];
     if (incomingQuery) {
       this.queryControl.setValue(incomingQuery);
       this.submitQuery();
       this.router.navigate([], { queryParams: { q: null }, queryParamsHandling: 'merge', replaceUrl: true });
     }
  });
}
