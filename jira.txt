// src/app/features/mybuddy/mybuddy.ts

private loadActiveThread(onComplete?: () => void) {
  this.isLoading.set(true);
  
  // âœ… REVERTED: We subscribe here again, so it works for reuseHistoryItem too
  this.ai.loadHistory(this.currentThreadId()).subscribe({
    next: (msgs) => {
      this.chatMessages.set(msgs);
      this.isLoading.set(false);
      
      // âœ… Run the callback if one was provided (e.g., for Redirects)
      if (onComplete) onComplete();
    },
    error: () => {
      this.chatMessages.set([]);
      this.isLoading.set(false);
      
      // Run callback even on error so we don't block the user
      if (onComplete) onComplete();
    }
  });
}

----------------
// src/app/features/mybuddy/mybuddy.ts

ngOnInit(): void {
  this.restoreSidebarHistory();

  // 1. Load History -> THEN Run the Auto-Prompt Logic
  this.loadActiveThread(() => {
    
    const state = history.state as { autoPrompt?: string };
    if (state && state.autoPrompt) {
      console.log('ðŸš€ Executing Auto-Prompt:', state.autoPrompt);
      
      // A. Populate the text box
      this.queryControl.setValue(state.autoPrompt);
      
      // B. "Press Enter" programmatically
      this.submitQuery();
    }
    
  });

  setTimeout(() => this.isInitializing.set(false), 1500);
  this.startHelperRotation();
  
  // URL Query Params Logic (Keep as is)
  this.route.queryParams.subscribe(params => {
     const incomingQuery = params['q'];
     if (incomingQuery) {
       this.queryControl.setValue(incomingQuery);
       this.submitQuery();
       this.router.navigate([], { queryParams: { q: null }, queryParamsHandling: 'merge', replaceUrl: true });
     }
  });
}

---------

reuseHistoryItem(item: ChatHistoryItem): void {
  this.currentThreadId.set(item.id);
  this.error.set(null);
  this.isAiTyping.set(false);
  
  // âœ… This works again because the method subscribes internally
  this.loadActiveThread(); 
  
  this.queryControl.setValue(item.query || '');
  if (window.innerWidth <= 1000) this.mobileView.set('chat');
}
