// 1. Wait for History to Load FIRST
  this.loadActiveThread().subscribe({
    next: (msgs) => {
      // A. Set the history
      this.chatMessages.set(msgs);
      this.isLoading.set(false);

      // B. NOW check for the redirect prompt (Safe to add now)
      this.checkAndRunAutoPrompt();
    },
    error: () => {
      this.chatMessages.set([]);
      this.isLoading.set(false);
      
      // Even if history fails, we still want to run the prompt
      this.checkAndRunAutoPrompt();
    }
  });

private checkAndRunAutoPrompt() {
  const state = history.state as { autoPrompt?: string };
  if (state && state.autoPrompt) {
    this.handleRedirectPrompt(state.autoPrompt);
  }
}
