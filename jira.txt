// âœ… FIX 1: Do not use a static string. Generate a unique session ID.
readonly currentThreadId = signal<string>(`session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`);

effect(() => {
        const user = this.currentUser();
        
        // If user logs out or changes
        if (user) {
            // Generate a fresh thread ID for the new session
            // OR restore the last active thread for THIS specific user from Sidebar history
            this.restoreLastActiveThreadForUser(user.id);
        }
    });


// Helper to switch context cleanly
private restoreLastActiveThreadForUser(userId: string) {
    const rawSidebar = localStorage.getItem(`wf_sidebar_${userId}`);
    if (rawSidebar) {
        try {
            const history = JSON.parse(rawSidebar);
            if (history.length > 0) {
                // Restore their last conversation
                this.currentThreadId.set(history[0].id);
            } else {
                // No history, start fresh
                this.currentThreadId.set(`thread-${Date.now()}`);
            }
        } catch {
            this.currentThreadId.set(`thread-${Date.now()}`);
        }
    } else {
        this.currentThreadId.set(`thread-${Date.now()}`);
    }

    // Now reload the messages for this specific thread + user combo
    this.loadActiveThread();
}
