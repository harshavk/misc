// src/app/features/mybuddy/mybuddy.ts
import { ChatAreaComponent } from './components/chat-area/chat-area'; 

export class MyBuddy implements OnInit, OnDestroy {
  @ViewChild(ChatAreaComponent) private chatArea!: ChatAreaComponent;

  ngOnInit(): void {
    // 1. Check State IMMEDIATELY (Synchronously)
    const state = history.state as { autoPrompt?: string };
    const hasRedirectPrompt = !!(state && state.autoPrompt); // Create a flag

    this.restoreSidebarHistory();

    // 2. Load History Logic
    this.loadActiveThread(() => {
      // If we have a redirect prompt, pre-fill it now
      if (hasRedirectPrompt) {
        console.log('ðŸ“ Pre-filling input from State:', state.autoPrompt);
        
        // Set value only (No Submit)
        this.queryControl.setValue(state.autoPrompt!);

        // Focus the child input
        setTimeout(() => {
          if (this.chatArea) this.chatArea.focusInput();
        }, 100);
      }
    });

    setTimeout(() => this.isInitializing.set(false), 1500);
    this.startHelperRotation();
    
    // 3. Query Params Logic (Blocked if Redirect exists)
    this.route.queryParams.subscribe(params => {
       const incomingQuery = params['q'];
       
       // ðŸ›‘ STOP: If we already have a redirect prompt, IGNORE the URL
       if (hasRedirectPrompt) {
         return; 
       }

       if (incomingQuery) {
         console.log('ðŸ”— Auto-submitting from URL');
         this.queryControl.setValue(incomingQuery);
         this.submitQuery();
         this.router.navigate([], { queryParams: { q: null }, queryParamsHandling: 'merge', replaceUrl: true });
       }
    });
  }
}
