// Inside MyBuddy class

  startNewChat(): void {
    // 1. Generate a TRULY unique ID
    const newId = this.generateThreadId();
    console.log('Starting New Chat with ID:', newId); // Debug check

    // 2. Update the Thread ID Signal
    this.currentThreadId.set(newId);

    // 3. FORCE CLEAR the messages and responses
    this.chatMessages.set([]); 
    this.lastResponse.set(null);
    this.error.set(null);

    // 4. Reset UI Inputs
    this.isAiTyping.set(false);
    this.queryControl.setValue('');
    
    // 5. Switch view if mobile
    if (window.innerWidth <= 1000) this.mobileView.set('chat');
  }

  // âœ… Helper to ensure unique IDs (Prevent collisions)
  private generateThreadId(): string {
    return `thread-${Date.now()}-${Math.floor(Math.random() * 10000)}`;
  }


effect(() => {
      const user = this.currentUser();
      
      // We check 'untracked' to prevent infinite loops if we modify signals inside
      if (user) {
        // Reset local state for the new user
        this.chatMessages.set([]);
        this.restoreSidebarHistoryForUser(user.id);
        this.restoreLastActiveThreadForUser(user.id);
      }
    }, { allowSignalWrites: true });
