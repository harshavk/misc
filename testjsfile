// Put this after WorkflowReportModule.Init(); inside document.ready
(function () {
    var tableSelector = '#workflowReportDataTable';
    var $table = $(tableSelector);
    if (!$table.length) { console.warn('table not found', tableSelector); return; }

    var table = $table.DataTable(); // assume already initialized

    function escapeRegex(text) {
        return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&');
    }

    var $currentDropdown = null;
    var debounceTimer = null;
    var closeHandler = null;

    // Prevent header click/sort when user presses the small filter button (mousedown stops DataTables handlers)
    $(document).on('mousedown.workflowFilter', tableSelector + ' thead .col-filter-btn', function (e) {
        e.preventDefault();
        // stopImmediatePropagation to try to block any other handlers attached to the same element
        e.stopImmediatePropagation();
        // also stop propagation so th click won't run
        e.stopPropagation();
    });

    // Main click handler - create dropdown
    $(document).on('click.workflowFilter', tableSelector + ' thead .col-filter-btn', function (e) {
        e.preventDefault();
        e.stopPropagation();

        // remove existing dropdown if any
        if ($currentDropdown) {
            $currentDropdown.remove();
            $currentDropdown = null;
        }

        var $btn = $(this);
        var $th = $btn.closest('th');
        var colIndex = $th.index();
        var column = table.column(colIndex);

        // get unique values
        var uniqueVals = column.data().toArray()
            .map(function (v) { return v === null || v === undefined ? '' : String(v); });
        var uniq = Array.from(new Set(uniqueVals)).sort(function (a, b) {
            var na = parseFloat(a), nb = parseFloat(b);
            if (!isNaN(na) && !isNaN(nb)) return na - nb;
            return a.localeCompare(b);
        });

        // build dropdown
        var $dropdown = $('<div class="filter-dropdown"></div>');
        var searchId = 'fs-' + Math.random().toString(36).substr(2, 9);
        $dropdown.append('<input type="text" class="filter-search" placeholder="Type to filter..." id="' + searchId + '" />');
        var selectAllId = 'sa-' + Math.random().toString(36).substr(2, 9);
        $dropdown.append('<label class="select-all"><input type="checkbox" id="' + selectAllId + '" checked> Select / Clear Visible</label>');
        var $list = $('<div class="filter-list"></div>');
        uniq.forEach(function (val, i) {
            var safeId = 'f-' + colIndex + '-' + i + '-' + Math.random().toString(36).substr(2, 6);
            var display = val === '' ? '(blank)' : val;
            var $label = $('<label></label>');
            var $chk = $('<input type="checkbox" class="filter-item" checked />').attr('data-value', val).attr('id', safeId);
            $label.append($chk).append(' <span>' + $('<div>').text(display).html() + '</span>');
            $list.append($label);
        });
        $dropdown.append($list);

        // append to body and position
        $('body').append($dropdown);
        var thOffset = $th.offset();
        $dropdown.css({
            top: thOffset.top + $th.outerHeight(),
            left: thOffset.left,
            position: 'absolute',
            zIndex: 99999
        });

        $currentDropdown = $dropdown;

        // search box (debounced)
        $('#' + searchId).on('keyup', function () {
            var q = $(this).val().trim().toLowerCase();
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(function () {
                $list.find('label').each(function () {
                    var text = $(this).text().trim().toLowerCase();
                    if (q === '' || text.indexOf(q) !== -1) $(this).show(); else $(this).hide();
                });
                var $visible = $list.find('label:visible .filter-item');
                var totalVisible = $visible.length;
                var checkedVisible = $visible.filter(':checked').length;
                $('#' + selectAllId).prop('checked', totalVisible > 0 && checkedVisible === totalVisible);
            }, 160);
        });

        // select/clear visible
        $dropdown.on('change', '#' + selectAllId, function () {
            var checked = $(this).is(':checked');
            $list.find('label:visible .filter-item').prop('checked', checked).trigger('change');
        });

        // checkbox change => apply column filter
        $dropdown.on('change', '.filter-item', function () {
            var $visibleCheckboxes = $list.find('label:visible .filter-item');
            if ($visibleCheckboxes.length > 0) {
                var checkedCountVisible = $visibleCheckboxes.filter(':checked').length;
                $('#' + selectAllId).prop('checked', checkedCountVisible === $visibleCheckboxes.length);
            } else {
                $('#' + selectAllId).prop('checked', false);
            }

            var selected = $list.find('.filter-item:checked').map(function () { return $(this).attr('data-value'); }).get();
            if (selected.length === 0) { column.search('', false, false).draw(); return; }
            var parts = selected.map(function (s) { return '^' + escapeRegex(s) + '$'; });
            var regex = parts.join('|');
            column.search(regex, true, false).draw();
        });

        // clicking inside dropdown shouldn't close it
        $dropdown.on('click', function (ev) { ev.stopPropagation(); });

        // Attach outside-click close handler AFTER current click completes.
        // setTimeout 0 ensures the handler won't see the opening click.
        if (closeHandler) { $(document).off('click.workflowFilterClose', closeHandler); closeHandler = null; }
        closeHandler = function (ev) {
            // close only if click is outside dropdown and outside the header button
            if ($currentDropdown && !$(ev.target).closest('.filter-dropdown, ' + tableSelector + ' thead .col-filter-btn').length) {
                console.log('closing dropdown by outside click');
                $currentDropdown.remove();
                $currentDropdown = null;
                $(document).off('click.workflowFilterClose', closeHandler);
                closeHandler = null;
            }
        };
        setTimeout(function () {
            $(document).on('click.workflowFilterClose', closeHandler);
        }, 0);

        // if the table redraws (paging, sorting, draw, responsive), remove dropdown to avoid ghost DOM references
        table.on('draw.dt.page.dt', function () {
            if ($currentDropdown) { $currentDropdown.remove(); $currentDropdown = null; }
        });

        // also remove on window resize/scroll
        $(window).on('resize.workflowFilter scroll.workflowFilter', function () {
            if ($currentDropdown) { $currentDropdown.remove(); $currentDropdown = null; }
        });
    });

    // Clean up if needed (optional)
    // $(document).off('.workflowFilter'); $(window).off('.workflowFilter'); table.off('.workflowFilter');
})();